# Solana 名片合约测试指南

## 测试概述

这个测试套件为 Solana 名片合约提供了全面的安全性和功能测试，包括：

### 1. 基本功能测试
- ✅ 成功设置用户偏好（数字、颜色、爱好）
- ✅ 更新已存在的用户偏好
- ✅ 验证不同用户的独立数据存储

### 2. 边界条件测试
- ✅ 最大长度颜色字符串（50字符）
- ✅ 最大数量和长度的爱好（5个，每个50字符）
- ✅ 空爱好数组处理
- ✅ 最大u64数值处理

### 3. 安全性测试
- ✅ 拒绝未签名的交易
- ✅ 防止用户修改他人的偏好数据
- ✅ PDA地址验证

### 4. 错误处理测试
- ✅ 拒绝超过长度限制的颜色字符串
- ✅ 拒绝超过数量限制的爱好
- ✅ 拒绝超过长度限制的单个爱好

### 5. 状态一致性测试
- ✅ 多次调用后的数据一致性验证

## 如何运行测试

### 前置条件
1. 确保已安装 Solana CLI 和 Anchor
2. 启动本地 Solana 测试验证器：
   ```bash
   solana-test-validator
   ```

### 构建和测试
1. 构建程序：
   ```bash
   anchor build
   ```

2. 运行所有测试：
   ```bash
   anchor test
   ```

3. 运行特定测试组：
   ```bash
   # 只运行基本功能测试
   anchor test --grep "基本功能测试"
   
   # 只运行安全性测试
   anchor test --grep "安全性测试"
   
   # 只运行边界条件测试
   anchor test --grep "边界条件测试"
   ```

### 测试环境配置
测试使用以下配置：
- 本地 Solana 集群
- 自动生成的测试用户账户
- 自动空投的测试 SOL

## 安全考虑

### 已验证的安全特性
1. **访问控制**：只有账户所有者可以修改自己的偏好
2. **PDA验证**：确保使用正确的程序派生地址
3. **数据隔离**：每个用户的数据独立存储
4. **输入验证**：严格的长度和数量限制

### 数据限制
- 颜色字符串：最大50字符
- 爱好数组：最多5个元素
- 每个爱好：最大50字符
- 数字：u64范围内的任意值

## 测试数据示例

```typescript
// 有效的测试数据
{
  number: 42,
  color: "蓝色",
  hobbies: ["编程", "音乐", "游戏"]
}

// 边界条件测试数据
{
  number: 18446744073709551615, // 最大u64
  color: "a".repeat(50),        // 最大长度颜色
  hobbies: [
    "a".repeat(50),             // 5个最大长度爱好
    "b".repeat(50),
    "c".repeat(50),
    "d".repeat(50),
    "e".repeat(50)
  ]
}
```

## 故障排除

### 常见问题
1. **测试失败：连接被拒绝**
   - 确保 `solana-test-validator` 正在运行
   - 检查 Anchor.toml 中的集群配置

2. **PDA相关错误**
   - 验证种子字符串是否正确
   - 确保程序ID匹配

3. **账户初始化失败**
   - 检查是否有足够的 SOL 用于租金豁免
   - 验证空间计算是否正确

### 调试技巧
- 使用 `console.log()` 输出交易签名和账户状态
- 检查 Solana 验证器日志获取详细错误信息
- 使用 `solana logs` 命令实时查看程序日志

## 性能考虑

这些测试涵盖了：
- 13个不同的测试用户
- 20+个独立测试用例
- 全面的错误路径验证
- 状态一致性检查

运行完整测试套件通常需要 30-60 秒，取决于网络延迟和计算资源。 